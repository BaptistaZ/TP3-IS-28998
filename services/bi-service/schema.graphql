# =============================================================================
# Object Types
# =============================================================================

"""
A persisted XML document record.

Returned by `docs`. Each document corresponds to one XML payload generated by the XML Service
and stored in Postgres.
"""
type Doc {
  "Database identifier of the stored XML document."
  id: Int!

  "Mapper version used by the Processor when generating the mapped CSV / XML."
  mapperVersion: String!

  "UTC timestamp (ISO-8601 string) when the document was created in the database."
  createdAt: String!
}

"""
A single incident extracted from an XML document.

Most fields are nullable because the XML source may omit elements/attributes,
and the XML Service exposes what exists without forcing defaults.
"""
type Incident {
  "ID of the XML document where this incident was extracted from."
  docId: Int!

  "Incident identifier as produced by the dataset generator / Processor."
  incidentId: String!

  "Origin of the incident report (e.g., citizen, sensor, authority, media)."
  source: String

  "Incident category/type (e.g., fire, flood, accident, outage)."
  incidentType: String

  "Severity level as stored in the XML attributes (typically '1'..'5')."
  severity: String

  "Workflow status (e.g., reported, validated, in_progress, resolved, cancelled)."
  status: String

  "City name from the Location block."
  city: String

  "Country name from the Location block."
  country: String

  "Continent name from the Location block."
  continent: String

  "Latitude coordinate (nullable if missing in XML)."
  lat: Float

  "Longitude coordinate (nullable if missing in XML)."
  lon: Float

  "Location accuracy in meters (nullable if missing in XML)."
  accuracyM: Float

  "When the incident was reported (ISO-8601 string, as stored in the XML)."
  reportedAt: String

  "When the incident was validated (ISO-8601 string, as stored in the XML)."
  validatedAt: String

  "When the incident was resolved (ISO-8601 string, as stored in the XML)."
  resolvedAt: String

  "Last update timestamp for the incident workflow (ISO-8601 string)."
  lastUpdateUtc: String

  "Response unit identifier assigned to the incident."
  assignedUnit: String

  "Number of response resources assigned (nullable if missing/blank)."
  resourcesCount: Float

  "Estimated time of arrival in minutes (nullable if missing/blank)."
  etaMin: Float

  "Actual response time in minutes (nullable if missing/blank)."
  responseTimeMin: Float

  "Estimated cost in EUR (nullable if missing/blank)."
  estimatedCostEur: Float

  "Risk score in [0,1] (nullable if missing/blank)."
  riskScore: Float

  "Free-text operator notes from the XML Meta block."
  notes: String
}

"""
Aggregation row grouped by incident type.
Used by `aggByType`.
"""
type AggByTypeRow {
  "Incident type / category (group key)."
  incidentType: String!

  "Total number of incidents for the given type."
  totalIncidents: Int!

  "Average risk score for the type (nullable if no risk values exist)."
  avgRiskScore: Float

  "Sum of estimated cost (EUR) for the type (nullable if no cost values exist)."
  totalEstimatedCostEur: Float
}

"""
Aggregation row grouped by severity.
Used by `aggBySeverity`.
"""
type AggBySeverityRow {
  "Severity level (group key)."
  severity: String!

  "Total number of incidents for the given severity."
  totalIncidents: Int!

  "Average risk score for the severity (nullable if no risk values exist)."
  avgRiskScore: Float
}

# =============================================================================
# Root Query
# =============================================================================

type Query {
  """
  Health probe for GraphQL layer.
  Returns "ok" when the service is running.
  """
  health: String!

  """
  List recent XML documents persisted in Postgres.
  """
  docs(limit: Int = 10): [Doc!]!

  """
  Query incidents extracted from persisted XML documents.

  Filters are optional. Pagination is supported via `limit` and `offset`.
  If `docId` is omitted, the XML Service typically defaults to the latest document.
  """
  incidents(
    docId: Int
    type: String
    severity: String
    status: String
    country: String
    limit: Int = 50
    offset: Int = 0
  ): [Incident!]!

  """
  Aggregation by incident type (KPIs for dashboards).
  """
  aggByType: [AggByTypeRow!]!

  """
  Aggregation by severity (KPIs for dashboards).
  """
  aggBySeverity: [AggBySeverityRow!]!
}