name: tp3-is-28998

services:
  # ---------------------------------------------------------------------------
  # Database: PostgreSQL with init scripts
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16
    container_name: postgres
    environment:
      POSTGRES_DB: tp3_is
      POSTGRES_USER: tp3_28998
      POSTGRES_PASSWORD: tp3pwd_28998
    ports:
      - "5432:5432"
    volumes:
      # Persistent data
      - tp3_pgdata:/var/lib/postgresql/data
      # SQL init scripts executed on first startup
      - ./init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tp3_28998 -d tp3_is"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ---------------------------------------------------------------------------
  # XML Service: ingest + XML generation/validation + DB persistence + REST queries
  # ---------------------------------------------------------------------------
  xml-service:
    build:
      context: ..
      dockerfile: services/xml-service/Dockerfile
    container_name: xml-service
    env_file:
      - .env.docker
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "7001:7001"
    volumes:
      # Optional: persisted XML debug outputs (enabled/disabled via env flags)
      - ../services/xml-service/generated-xml:/app/generated-xml

  # ---------------------------------------------------------------------------
  # gRPC Service: gRPC interface backed by the same Postgres XML store
  # ---------------------------------------------------------------------------
  grpc-service:
    build:
      context: ..
      dockerfile: services/grpc-service/Dockerfile
    container_name: grpc-service
    env_file:
      - .env.docker
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "50051:50051"

  # ---------------------------------------------------------------------------
  # XML-RPC Service (Java): provides FX rate used during enrichment (EUR->USD)
  # ---------------------------------------------------------------------------
  rpc-service:
    build:
      context: ../services/rpc-service-java
      dockerfile: Dockerfile
    container_name: rpc-service
    env_file:
      - .env.docker
    ports:
      - "9000:9000"

  # ---------------------------------------------------------------------------
  # Processor: async worker that polls Supabase S3 and drives ingest + webhook flow
  # ---------------------------------------------------------------------------
  processor:
    build:
      context: ..
      dockerfile: services/processor/Dockerfile
    container_name: processor
    env_file:
      - .env.docker
    environment:
      - PYTHONUNBUFFERED=1
    command: ["python", "-u", "processor.py"]
    depends_on:
      xml-service:
        condition: service_started
      rpc-service:
        condition: service_started
      webhook:
        condition: service_started
    volumes:
      # Shared volume with webhook to persist state, temp files, and mapped CSV artifacts
      - processor_tmp:/app/tmp
      # Mapper definition passed into the container as read-only
      - ../services/processor/mapper.json:/app/mapper.json:ro

  # ---------------------------------------------------------------------------
  # Webhook receiver: receives xml-service callbacks (OK / validation / persistence errors)
  # ---------------------------------------------------------------------------
  webhook:
    build:
      context: ..
      dockerfile: services/processor/Dockerfile
    container_name: webhook
    env_file:
      - .env.docker
    command: ["python", "webhook_server.py"]
    ports:
      - "8000:8000"
    volumes:
      # Share processor state and artifacts with the processor service
      - processor_tmp:/app/tmp

  # ---------------------------------------------------------------------------
  # Crawler: produces CSV inputs by uploading to Supabase S3 (incoming/)
  # ---------------------------------------------------------------------------
  crawler:
    build:
      context: ..
      dockerfile: services/crawler/Dockerfile
    container_name: crawler
    env_file:
      - .env.docker
    depends_on:
      processor:
        condition: service_started
    volumes:
      # Local datasets are mounted for sample CSV generation / selection
      - ../datasets:/app/datasets

  # ---------------------------------------------------------------------------
  # BI Service: GraphQL API used by the frontend; calls xml-service (REST) + grpc-service (gRPC)
  # ---------------------------------------------------------------------------
  bi-service:
    build:
      context: ..
      dockerfile: services/bi-service/Dockerfile
    container_name: bi-service
    env_file:
      - .env.docker
    depends_on:
      grpc-service:
        condition: service_started
    ports:
      - "4000:4000"

  # ---------------------------------------------------------------------------
  # Frontend: static UI served by Nginx, consuming the BI GraphQL API
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "8080:80"
    depends_on:
      - bi-service
    restart: unless-stopped

# -----------------------------------------------------------------------------
# Named volumes
# -----------------------------------------------------------------------------
volumes:
  tp3_pgdata:
  processor_tmp: